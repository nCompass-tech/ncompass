# Modal PyTorch Profiling with nCompass SDK

This example demonstrates how to profile GPU-accelerated PyTorch neural network training on [Modal](https://modal.com) with integrated [nCompass SDK](https://ncompass.tech) tracing and instrumentation.

> **Note**: This example is derived from the [Modal torch_profiling example](https://modal.com/docs/examples/torch_profiling#tracing-and-profiling-gpu-accelerated-pytorch-programs-on-modal).

## Overview

This example shows how to:
1. Set up a Modal App with GPU support (A10G)
2. Integrate nCompass SDK for tracing and instrumentation
3. Train a simple neural network with instrumentation
4. Profile GPU-accelerated PyTorch code using PyTorch's built-in profiler
5. Link user annotations to GPU kernels for better trace visualization
6. Save profiling traces to a Modal Volume and download them locally

## Prerequisites

- **Modal account**: Sign up at [modal.com](https://modal.com) and authenticate using `modal setup`
- **nCompass VSCode Extension**: Install the [nCompass extension](https://docs.ncompass.tech/ncprof/quick-start) to add tracepoints and manage profiling
- **Python 3.12+**: Required for running the example

## Installation

1. Install Modal:
```bash
pip install modal
```

2. Authenticate with Modal:
```bash
modal setup
```

3. Install requirements (if running locally):
```bash
pip install -r requirements.txt
```

## Usage

### Basic Profiling

Run the example with default settings:
```bash
modal run torch_profiling_example.py
```

## Output

The example produces:
1. **Console output**: Summary table of top operations (if `--print-rows` > 0)
2. **Trace files**: JSON trace files saved to Modal Volume and downloaded locally. Initially, this
   will be without any custom markers.

Example output:
```
trace saved to train_simple_network/abc123-def456-...
Linking user_annotation events to kernels...
Linked 5 user_annotation events to kernels
Trace updated: train_simple_network/abc123-def456-.../trace.pt.trace.json
trace saved locally at .traces/trace.pt.trace.json - view using the nCompass VSCode extension
```

## Viewing Traces

Open the generated trace file (`.pt.trace.json`) using [nCompass VSCode Extension](https://docs.ncompass.tech/ncprof/quick-start)

## How to Add Custom Tracepoints

1. Open the training function in VSCode
2. Use the nCompass extension to add tracepoints at regions of interest
3. The extension updates the local `config.json` file
4. Re-run the Modal script - the updated config will be copied to the container
5. Your custom annotations will appear in the generated traces

## Custom Parameters

Profile with specific configurations:
```bash
# Custom label and more profiling steps
modal run torch_profiling_example.py --label "baseline" --steps 5

# Show top 20 operations in summary table
modal run torch_profiling_example.py --print-rows 20

# Save traces to a custom local directory
modal run torch_profiling_example.py --local-trace-dir ./my-traces

# Disable annotation linking
modal run torch_profiling_example.py --no-link

# Show detailed linking statistics
modal run torch_profiling_example.py --verbose
```

### Advanced Options

Available command-line arguments:
- `--function`: Name of the function to profile (default: "train_simple_network")
- `--label`: Optional label for the profiling run
- `--steps`: Number of profiling steps (default: 3)
- `--record-shapes`: Record tensor shapes during profiling
- `--profile-memory`: Profile memory usage
- `--with-stack`: Include Python stack traces
- `--print-rows`: Number of rows to print in summary table (default: 10)
- `--local-trace-dir`: Local directory to save traces (default: ".traces")
- `--no-link`: Disable linking user annotations to kernels
- `--verbose`: Show detailed linking statistics


## How It Works

### nCompass Integration

The example integrates nCompass SDK to enable custom tracepoint instrumentation. The line numbers
refer to locations in the `torch_profiling_example.py` file:

1. **Config File**: The local `config.json` file (generated by the nCompass VSCode extension) is 
   copied into the Modal container. This file contains tracepoint definitions [Lines 28-43].

2. **Dependencies**: nCompass and dependent libraries are installed into the Modal environment 
   [Lines 49-55].

4. **SDK Initialization**: Before profiling, the SDK is initialized with the config to inject 
   trace markers [Lines 143-151]. It's important to note that this should be done before functions
   being profiled and outside a function you want to add tracepoints to.
```python
with open("/config/ncompass_config.json") as f:
    cfg = json.load(f)
    enable_rewrites(config=RewriteConfig.from_dict(cfg))
```

4. **Annotation Linking**: User annotations are automatically linked to GPU kernels for better 
   visualization in Perfetto traces [Lines 205-325]. Note that this functionality will be absorbed
   into the SDK for future releases.

### Training Function

The `train_simple_network` function demonstrates a typical PyTorch training loop:
- Creates a simple feedforward neural network
- Trains on dummy data for a specified number of epochs
- Runs entirely on GPU (CUDA)

### Profiling Function

The `profile` function wraps any Modal function with PyTorch profiling:
- Uses PyTorch's built-in profiler to capture CPU and CUDA activities
- Records timing, kernel launches, and optionally memory usage
- Saves traces in TensorBoard format (`.pt.trace.json`)
- Links user annotations to GPU kernels for enhanced visualization

## Files

- `torch_profiling_example.py`: Main example script with Modal app definition
- `requirements.txt`: Python dependencies for local development
- `README.md`: This file

## References

- [Modal Documentation](https://modal.com/docs)
- [Modal PyTorch Profiling Example](https://modal.com/docs/examples/torch_profiling)
- [nCompass SDK](https://ncompass.tech)
- [PyTorch Profiler](https://pytorch.org/docs/stable/profiler.html)
- [Perfetto Trace Viewer](https://ui.perfetto.dev)

## Troubleshooting

### Config File Not Found
If you see an error about missing `config.json`, ensure:
1. The nCompass VSCode extension is installed and initialized
2. You've created at least one profile in nCompass
3. The path in the image definition matches your config location

### GPU Not Available
Modal will automatically provision a GPU. If issues occur:
- Check your Modal account has GPU access
- Try a different GPU type by modifying `config = {"gpu": "a10g", "image": image}`

### Trace Files Not Linking
If user annotations aren't linking to kernels:
- Ensure tracepoints are placed in GPU-executed code
- Check that the profiler captures both CPU and CUDA activities
- Use `--verbose` flag to see detailed linking statistics

